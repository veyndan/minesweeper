{"version":3,"sources":["pack.js"],"names":[],"mappings":"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","file":"pack-compiled.js","sourcesContent":["// pipe in an fstream, and it'll make a tarball.\n// key-value pair argument is global extended header props.\n\nmodule.exports = Pack\n\nvar EntryWriter = require(\"./entry-writer.js\")\n  , Stream = require(\"stream\").Stream\n  , path = require(\"path\")\n  , inherits = require(\"inherits\")\n  , GlobalHeaderWriter = require(\"./global-header-writer.js\")\n  , collect = require(\"fstream\").collect\n  , eof = new Buffer(512)\n\nfor (var i = 0; i < 512; i ++) eof[i] = 0\n\ninherits(Pack, Stream)\n\nfunction Pack (props) {\n  // console.error(\"-- p ctor\")\n  var me = this\n  if (!(me instanceof Pack)) return new Pack(props)\n\n  if (props) me._noProprietary = props.noProprietary\n  else me._noProprietary = false\n\n  me._global = props\n\n  me.readable = true\n  me.writable = true\n  me._buffer = []\n  // console.error(\"-- -- set current to null in ctor\")\n  me._currentEntry = null\n  me._processing = false\n\n  me._pipeRoot = null\n  me.on(\"pipe\", function (src) {\n    if (src.root === me._pipeRoot) return\n    me._pipeRoot = src\n    src.on(\"end\", function () {\n      me._pipeRoot = null\n    })\n    me.add(src)\n  })\n}\n\nPack.prototype.addGlobal = function (props) {\n  // console.error(\"-- p addGlobal\")\n  if (this._didGlobal) return\n  this._didGlobal = true\n\n  var me = this\n  GlobalHeaderWriter(props)\n    .on(\"data\", function (c) {\n      me.emit(\"data\", c)\n    })\n    .end()\n}\n\nPack.prototype.add = function (stream) {\n  if (this._global && !this._didGlobal) this.addGlobal(this._global)\n\n  if (this._ended) return this.emit(\"error\", new Error(\"add after end\"))\n\n  collect(stream)\n  this._buffer.push(stream)\n  this._process()\n  this._needDrain = this._buffer.length > 0\n  return !this._needDrain\n}\n\nPack.prototype.pause = function () {\n  this._paused = true\n  if (this._currentEntry) this._currentEntry.pause()\n  this.emit(\"pause\")\n}\n\nPack.prototype.resume = function () {\n  this._paused = false\n  if (this._currentEntry) this._currentEntry.resume()\n  this.emit(\"resume\")\n  this._process()\n}\n\nPack.prototype.end = function () {\n  this._ended = true\n  this._buffer.push(eof)\n  this._process()\n}\n\nPack.prototype._process = function () {\n  var me = this\n  if (me._paused || me._processing) {\n    return\n  }\n\n  var entry = me._buffer.shift()\n\n  if (!entry) {\n    if (me._needDrain) {\n      me.emit(\"drain\")\n    }\n    return\n  }\n\n  if (entry.ready === false) {\n    // console.error(\"-- entry is not ready\", entry)\n    me._buffer.unshift(entry)\n    entry.on(\"ready\", function () {\n      // console.error(\"-- -- ready!\", entry)\n      me._process()\n    })\n    return\n  }\n\n  me._processing = true\n\n  if (entry === eof) {\n    // need 2 ending null blocks.\n    me.emit(\"data\", eof)\n    me.emit(\"data\", eof)\n    me.emit(\"end\")\n    me.emit(\"close\")\n    return\n  }\n\n  // Change the path to be relative to the root dir that was\n  // added to the tarball.\n  //\n  // XXX This should be more like how -C works, so you can\n  // explicitly set a root dir, and also explicitly set a pathname\n  // in the tarball to use.  That way we can skip a lot of extra\n  // work when resolving symlinks for bundled dependencies in npm.\n\n  var root = path.dirname((entry.root || entry).path)\n  var wprops = {}\n\n  Object.keys(entry.props || {}).forEach(function (k) {\n    wprops[k] = entry.props[k]\n  })\n\n  if (me._noProprietary) wprops.noProprietary = true\n\n  wprops.path = path.relative(root, entry.path || '')\n\n  // actually not a matter of opinion or taste.\n  if (process.platform === \"win32\") {\n    wprops.path = wprops.path.replace(/\\\\/g, \"/\")\n  }\n\n  if (!wprops.type)\n    wprops.type = 'Directory'\n\n  switch (wprops.type) {\n    // sockets not supported\n    case \"Socket\":\n      return\n\n    case \"Directory\":\n      wprops.path += \"/\"\n      wprops.size = 0\n      break\n\n    case \"Link\":\n      var lp = path.resolve(path.dirname(entry.path), entry.linkpath)\n      wprops.linkpath = path.relative(root, lp) || \".\"\n      wprops.size = 0\n      break\n\n    case \"SymbolicLink\":\n      var lp = path.resolve(path.dirname(entry.path), entry.linkpath)\n      wprops.linkpath = path.relative(path.dirname(entry.path), lp) || \".\"\n      wprops.size = 0\n      break\n  }\n\n  // console.error(\"-- new writer\", wprops)\n  // if (!wprops.type) {\n  //   // console.error(\"-- no type?\", entry.constructor.name, entry)\n  // }\n\n  // console.error(\"-- -- set current to new writer\", wprops.path)\n  var writer = me._currentEntry = EntryWriter(wprops)\n\n  writer.parent = me\n\n  // writer.on(\"end\", function () {\n  //   // console.error(\"-- -- writer end\", writer.path)\n  // })\n\n  writer.on(\"data\", function (c) {\n    me.emit(\"data\", c)\n  })\n\n  writer.on(\"header\", function () {\n    Buffer.prototype.toJSON = function () {\n      return this.toString().split(/\\0/).join(\".\")\n    }\n    // console.error(\"-- -- writer header %j\", writer.props)\n    if (writer.props.size === 0) nextEntry()\n  })\n  writer.on(\"close\", nextEntry)\n\n  var ended = false\n  function nextEntry () {\n    if (ended) return\n    ended = true\n\n    // console.error(\"-- -- writer close\", writer.path)\n    // console.error(\"-- -- set current to null\", wprops.path)\n    me._currentEntry = null\n    me._processing = false\n    me._process()\n  }\n\n  writer.on(\"error\", function (er) {\n    // console.error(\"-- -- writer error\", writer.path)\n    me.emit(\"error\", er)\n  })\n\n  // if it's the root, then there's no need to add its entries,\n  // or data, since they'll be added directly.\n  if (entry === me._pipeRoot) {\n    // console.error(\"-- is the root, don't auto-add\")\n    writer.add = null\n  }\n\n  entry.pipe(writer)\n}\n\nPack.prototype.destroy = function () {}\nPack.prototype.write = function () {}\n"]}