{"version":3,"sources":["entry-writer.js"],"names":[],"mappings":"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","file":"entry-writer-compiled.js","sourcesContent":["module.exports = EntryWriter\n\nvar tar = require(\"../tar.js\")\n  , TarHeader = require(\"./header.js\")\n  , Entry = require(\"./entry.js\")\n  , inherits = require(\"inherits\")\n  , BlockStream = require(\"block-stream\")\n  , ExtendedHeaderWriter\n  , Stream = require(\"stream\").Stream\n  , EOF = {}\n\ninherits(EntryWriter, Stream)\n\nfunction EntryWriter (props) {\n  var me = this\n\n  if (!(me instanceof EntryWriter)) {\n    return new EntryWriter(props)\n  }\n\n  Stream.apply(this)\n\n  me.writable = true\n  me.readable = true\n\n  me._stream = new BlockStream(512)\n\n  me._stream.on(\"data\", function (c) {\n    me.emit(\"data\", c)\n  })\n\n  me._stream.on(\"drain\", function () {\n    me.emit(\"drain\")\n  })\n\n  me._stream.on(\"end\", function () {\n    me.emit(\"end\")\n    me.emit(\"close\")\n  })\n\n  me.props = props\n  if (props.type === \"Directory\") {\n    props.size = 0\n  }\n  props.ustar = \"ustar\\0\"\n  props.ustarver = \"00\"\n  me.path = props.path\n\n  me._buffer = []\n  me._didHeader = false\n  me._meta = false\n\n  me.on(\"pipe\", function () {\n    me._process()\n  })\n}\n\nEntryWriter.prototype.write = function (c) {\n  // console.error(\".. ew write\")\n  if (this._ended) return this.emit(\"error\", new Error(\"write after end\"))\n  this._buffer.push(c)\n  this._process()\n  this._needDrain = this._buffer.length > 0\n  return !this._needDrain\n}\n\nEntryWriter.prototype.end = function (c) {\n  // console.error(\".. ew end\")\n  if (c) this._buffer.push(c)\n  this._buffer.push(EOF)\n  this._ended = true\n  this._process()\n  this._needDrain = this._buffer.length > 0\n}\n\nEntryWriter.prototype.pause = function () {\n  // console.error(\".. ew pause\")\n  this._paused = true\n  this.emit(\"pause\")\n}\n\nEntryWriter.prototype.resume = function () {\n  // console.error(\".. ew resume\")\n  this._paused = false\n  this.emit(\"resume\")\n  this._process()\n}\n\nEntryWriter.prototype.add = function (entry) {\n  // console.error(\".. ew add\")\n  if (!this.parent) return this.emit(\"error\", new Error(\"no parent\"))\n\n  // make sure that the _header and such is emitted, and clear out\n  // the _currentEntry link on the parent.\n  if (!this._ended) this.end()\n\n  return this.parent.add(entry)\n}\n\nEntryWriter.prototype._header = function () {\n  // console.error(\".. ew header\")\n  if (this._didHeader) return\n  this._didHeader = true\n\n  var headerBlock = TarHeader.encode(this.props)\n\n  if (this.props.needExtended && !this._meta) {\n    var me = this\n\n    ExtendedHeaderWriter = ExtendedHeaderWriter ||\n      require(\"./extended-header-writer.js\")\n\n    ExtendedHeaderWriter(this.props)\n      .on(\"data\", function (c) {\n        me.emit(\"data\", c)\n      })\n      .on(\"error\", function (er) {\n        me.emit(\"error\", er)\n      })\n      .end()\n  }\n\n  // console.error(\".. .. ew headerBlock emitting\")\n  this.emit(\"data\", headerBlock)\n  this.emit(\"header\")\n}\n\nEntryWriter.prototype._process = function () {\n  // console.error(\".. .. ew process\")\n  if (!this._didHeader && !this._meta) {\n    this._header()\n  }\n\n  if (this._paused || this._processing) {\n    // console.error(\".. .. .. paused=%j, processing=%j\", this._paused, this._processing)\n    return\n  }\n\n  this._processing = true\n\n  var buf = this._buffer\n  for (var i = 0; i < buf.length; i ++) {\n    // console.error(\".. .. .. i=%d\", i)\n\n    var c = buf[i]\n\n    if (c === EOF) this._stream.end()\n    else this._stream.write(c)\n\n    if (this._paused) {\n      // console.error(\".. .. .. paused mid-emission\")\n      this._processing = false\n      if (i < buf.length) {\n        this._needDrain = true\n        this._buffer = buf.slice(i + 1)\n      }\n      return\n    }\n  }\n\n  // console.error(\".. .. .. emitted\")\n  this._buffer.length = 0\n  this._processing = false\n\n  // console.error(\".. .. .. emitting drain\")\n  this.emit(\"drain\")\n}\n\nEntryWriter.prototype.destroy = function () {}\n"]}