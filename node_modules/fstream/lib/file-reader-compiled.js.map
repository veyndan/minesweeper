{"version":3,"sources":["file-reader.js"],"names":[],"mappings":"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","file":"file-reader-compiled.js","sourcesContent":["// Basically just a wrapper around an fs.ReadStream\n\nmodule.exports = FileReader\n\nvar fs = require(\"graceful-fs\")\n  , fstream = require(\"../fstream.js\")\n  , Reader = fstream.Reader\n  , inherits = require(\"inherits\")\n  , mkdir = require(\"mkdirp\")\n  , Reader = require(\"./reader.js\")\n  , EOF = {EOF: true}\n  , CLOSE = {CLOSE: true}\n\ninherits(FileReader, Reader)\n\nfunction FileReader (props) {\n  // console.error(\"    FR create\", props.path, props.size, new Error().stack)\n  var me = this\n  if (!(me instanceof FileReader)) throw new Error(\n    \"FileReader must be called as constructor.\")\n\n  // should already be established as a File type\n  // XXX Todo: preserve hardlinks by tracking dev+inode+nlink,\n  // with a HardLinkReader class.\n  if (!((props.type === \"Link\" && props.Link) ||\n        (props.type === \"File\" && props.File))) {\n    throw new Error(\"Non-file type \"+ props.type)\n  }\n\n  me._buffer = []\n  me._bytesEmitted = 0\n  Reader.call(me, props)\n}\n\nFileReader.prototype._getStream = function () {\n  var me = this\n    , stream = me._stream = fs.createReadStream(me._path, me.props)\n\n  if (me.props.blksize) {\n    stream.bufferSize = me.props.blksize\n  }\n\n  stream.on(\"open\", me.emit.bind(me, \"open\"))\n\n  stream.on(\"data\", function (c) {\n    // console.error(\"\\t\\t%d %s\", c.length, me.basename)\n    me._bytesEmitted += c.length\n    // no point saving empty chunks\n    if (!c.length) return\n    else if (me._paused || me._buffer.length) {\n      me._buffer.push(c)\n      me._read()\n    } else me.emit(\"data\", c)\n  })\n\n  stream.on(\"end\", function () {\n    if (me._paused || me._buffer.length) {\n      // console.error(\"FR Buffering End\", me._path)\n      me._buffer.push(EOF)\n      me._read()\n    } else {\n      me.emit(\"end\")\n    }\n\n    if (me._bytesEmitted !== me.props.size) {\n      me.error(\"Didn't get expected byte count\\n\"+\n               \"expect: \"+me.props.size + \"\\n\" +\n               \"actual: \"+me._bytesEmitted)\n    }\n  })\n\n  stream.on(\"close\", function () {\n    if (me._paused || me._buffer.length) {\n      // console.error(\"FR Buffering Close\", me._path)\n      me._buffer.push(CLOSE)\n      me._read()\n    } else {\n      // console.error(\"FR close 1\", me._path)\n      me.emit(\"close\")\n    }\n  })\n\n  me._read()\n}\n\nFileReader.prototype._read = function () {\n  var me = this\n  // console.error(\"FR _read\", me._path)\n  if (me._paused) {\n    // console.error(\"FR _read paused\", me._path)\n    return\n  }\n\n  if (!me._stream) {\n    // console.error(\"FR _getStream calling\", me._path)\n    return me._getStream()\n  }\n\n  // clear out the buffer, if there is one.\n  if (me._buffer.length) {\n    // console.error(\"FR _read has buffer\", me._buffer.length, me._path)\n    var buf = me._buffer\n    for (var i = 0, l = buf.length; i < l; i ++) {\n      var c = buf[i]\n      if (c === EOF) {\n        // console.error(\"FR Read emitting buffered end\", me._path)\n        me.emit(\"end\")\n      } else if (c === CLOSE) {\n        // console.error(\"FR Read emitting buffered close\", me._path)\n        me.emit(\"close\")\n      } else {\n        // console.error(\"FR Read emitting buffered data\", me._path)\n        me.emit(\"data\", c)\n      }\n\n      if (me._paused) {\n        // console.error(\"FR Read Re-pausing at \"+i, me._path)\n        me._buffer = buf.slice(i)\n        return\n      }\n    }\n    me._buffer.length = 0\n  }\n  // console.error(\"FR _read done\")\n  // that's about all there is to it.\n}\n\nFileReader.prototype.pause = function (who) {\n  var me = this\n  // console.error(\"FR Pause\", me._path)\n  if (me._paused) return\n  who = who || me\n  me._paused = true\n  if (me._stream) me._stream.pause()\n  me.emit(\"pause\", who)\n}\n\nFileReader.prototype.resume = function (who) {\n  var me = this\n  // console.error(\"FR Resume\", me._path)\n  if (!me._paused) return\n  who = who || me\n  me.emit(\"resume\", who)\n  me._paused = false\n  if (me._stream) me._stream.resume()\n  me._read()\n}\n"]}