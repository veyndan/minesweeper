{"version":3,"sources":["file-writer.js"],"names":[],"mappings":"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","file":"file-writer-compiled.js","sourcesContent":["module.exports = FileWriter\n\nvar fs = require(\"graceful-fs\")\n  , mkdir = require(\"mkdirp\")\n  , Writer = require(\"./writer.js\")\n  , inherits = require(\"inherits\")\n  , EOF = {}\n\ninherits(FileWriter, Writer)\n\nfunction FileWriter (props) {\n  var me = this\n  if (!(me instanceof FileWriter)) throw new Error(\n    \"FileWriter must be called as constructor.\")\n\n  // should already be established as a File type\n  if (props.type !== \"File\" || !props.File) {\n    throw new Error(\"Non-file type \"+ props.type)\n  }\n\n  me._buffer = []\n  me._bytesWritten = 0\n\n  Writer.call(this, props)\n}\n\nFileWriter.prototype._create = function () {\n  var me = this\n  if (me._stream) return\n\n  var so = {}\n  if (me.props.flags) so.flags = me.props.flags\n  so.mode = Writer.filemode\n  if (me._old && me._old.blksize) so.bufferSize = me._old.blksize\n\n  me._stream = fs.createWriteStream(me._path, so)\n\n  me._stream.on(\"open\", function (fd) {\n    // console.error(\"FW open\", me._buffer, me._path)\n    me.ready = true\n    me._buffer.forEach(function (c) {\n      if (c === EOF) me._stream.end()\n      else me._stream.write(c)\n    })\n    me.emit(\"ready\")\n    // give this a kick just in case it needs it.\n    me.emit(\"drain\")\n  })\n\n  me._stream.on(\"drain\", function () { me.emit(\"drain\") })\n\n  me._stream.on(\"close\", function () {\n    // console.error(\"\\n\\nFW Stream Close\", me._path, me.size)\n    me._finish()\n  })\n}\n\nFileWriter.prototype.write = function (c) {\n  var me = this\n\n  me._bytesWritten += c.length\n\n  if (!me.ready) {\n    if (!Buffer.isBuffer(c) && typeof c !== 'string')\n      throw new Error('invalid write data')\n    me._buffer.push(c)\n    return false\n  }\n\n  var ret = me._stream.write(c)\n  // console.error(\"\\t-- fw wrote, _stream says\", ret, me._stream._queue.length)\n\n  // allow 2 buffered writes, because otherwise there's just too\n  // much stop and go bs.\n  if (ret === false && me._stream._queue) {\n    return me._stream._queue.length <= 2;\n  } else {\n    return ret;\n  }\n}\n\nFileWriter.prototype.end = function (c) {\n  var me = this\n\n  if (c) me.write(c)\n\n  if (!me.ready) {\n    me._buffer.push(EOF)\n    return false\n  }\n\n  return me._stream.end()\n}\n\nFileWriter.prototype._finish = function () {\n  var me = this\n  if (typeof me.size === \"number\" && me._bytesWritten != me.size) {\n    me.error(\n      \"Did not get expected byte count.\\n\" +\n      \"expect: \" + me.size + \"\\n\" +\n      \"actual: \" + me._bytesWritten)\n  }\n  Writer.prototype._finish.call(me)\n}\n"]}