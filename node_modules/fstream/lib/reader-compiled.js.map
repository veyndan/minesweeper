{"version":3,"sources":["reader.js"],"names":[],"mappings":"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","file":"reader-compiled.js","sourcesContent":["\nmodule.exports = Reader\n\nvar fs = require(\"graceful-fs\")\n  , Stream = require(\"stream\").Stream\n  , inherits = require(\"inherits\")\n  , path = require(\"path\")\n  , getType = require(\"./get-type.js\")\n  , hardLinks = Reader.hardLinks = {}\n  , Abstract = require(\"./abstract.js\")\n\n// Must do this *before* loading the child classes\ninherits(Reader, Abstract)\n\nvar DirReader = require(\"./dir-reader.js\")\n  , FileReader = require(\"./file-reader.js\")\n  , LinkReader = require(\"./link-reader.js\")\n  , SocketReader = require(\"./socket-reader.js\")\n  , ProxyReader = require(\"./proxy-reader.js\")\n\nfunction Reader (props, currentStat) {\n  var me = this\n  if (!(me instanceof Reader)) return new Reader(props, currentStat)\n\n  if (typeof props === \"string\") {\n    props = { path: props }\n  }\n\n  if (!props.path) {\n    me.error(\"Must provide a path\", null, true)\n  }\n\n  // polymorphism.\n  // call fstream.Reader(dir) to get a DirReader object, etc.\n  // Note that, unlike in the Writer case, ProxyReader is going\n  // to be the *normal* state of affairs, since we rarely know\n  // the type of a file prior to reading it.\n\n\n  var type\n    , ClassType\n\n  if (props.type && typeof props.type === \"function\") {\n    type = props.type\n    ClassType = type\n  } else {\n    type = getType(props)\n    ClassType = Reader\n  }\n\n  if (currentStat && !type) {\n    type = getType(currentStat)\n    props[type] = true\n    props.type = type\n  }\n\n  switch (type) {\n    case \"Directory\":\n      ClassType = DirReader\n      break\n\n    case \"Link\":\n      // XXX hard links are just files.\n      // However, it would be good to keep track of files' dev+inode\n      // and nlink values, and create a HardLinkReader that emits\n      // a linkpath value of the original copy, so that the tar\n      // writer can preserve them.\n      // ClassType = HardLinkReader\n      // break\n\n    case \"File\":\n      ClassType = FileReader\n      break\n\n    case \"SymbolicLink\":\n      ClassType = LinkReader\n      break\n\n    case \"Socket\":\n      ClassType = SocketReader\n      break\n\n    case null:\n      ClassType = ProxyReader\n      break\n  }\n\n  if (!(me instanceof ClassType)) {\n    return new ClassType(props)\n  }\n\n  Abstract.call(me)\n\n  me.readable = true\n  me.writable = false\n\n  me.type = type\n  me.props = props\n  me.depth = props.depth = props.depth || 0\n  me.parent = props.parent || null\n  me.root = props.root || (props.parent && props.parent.root) || me\n\n  me._path = me.path = path.resolve(props.path)\n  if (process.platform === \"win32\") {\n    me.path = me._path = me.path.replace(/\\?/g, \"_\")\n    if (me._path.length >= 260) {\n      // how DOES one create files on the moon?\n      // if the path has spaces in it, then UNC will fail.\n      me._swallowErrors = true\n      //if (me._path.indexOf(\" \") === -1) {\n        me._path = \"\\\\\\\\?\\\\\" + me.path.replace(/\\//g, \"\\\\\")\n      //}\n    }\n  }\n  me.basename = props.basename = path.basename(me.path)\n  me.dirname = props.dirname = path.dirname(me.path)\n\n  // these have served their purpose, and are now just noisy clutter\n  props.parent = props.root = null\n\n  // console.error(\"\\n\\n\\n%s setting size to\", props.path, props.size)\n  me.size = props.size\n  me.filter = typeof props.filter === \"function\" ? props.filter : null\n  if (props.sort === \"alpha\") props.sort = alphasort\n\n  // start the ball rolling.\n  // this will stat the thing, and then call me._read()\n  // to start reading whatever it is.\n  // console.error(\"calling stat\", props.path, currentStat)\n  me._stat(currentStat)\n}\n\nfunction alphasort (a, b) {\n  return a === b ? 0\n       : a.toLowerCase() > b.toLowerCase() ? 1\n       : a.toLowerCase() < b.toLowerCase() ? -1\n       : a > b ? 1\n       : -1\n}\n\nReader.prototype._stat = function (currentStat) {\n  var me = this\n    , props = me.props\n    , stat = props.follow ? \"stat\" : \"lstat\"\n  // console.error(\"Reader._stat\", me._path, currentStat)\n  if (currentStat) process.nextTick(statCb.bind(null, null, currentStat))\n  else fs[stat](me._path, statCb)\n\n\n  function statCb (er, props_) {\n    // console.error(\"Reader._stat, statCb\", me._path, props_, props_.nlink)\n    if (er) return me.error(er)\n\n    Object.keys(props_).forEach(function (k) {\n      props[k] = props_[k]\n    })\n\n    // if it's not the expected size, then abort here.\n    if (undefined !== me.size && props.size !== me.size) {\n      return me.error(\"incorrect size\")\n    }\n    me.size = props.size\n\n    var type = getType(props)\n    var handleHardlinks = props.hardlinks !== false\n    \n    // special little thing for handling hardlinks.\n    if (handleHardlinks && type !== \"Directory\" && props.nlink && props.nlink > 1) {\n      var k = props.dev + \":\" + props.ino\n      // console.error(\"Reader has nlink\", me._path, k)\n      if (hardLinks[k] === me._path || !hardLinks[k]) hardLinks[k] = me._path\n      else {\n        // switch into hardlink mode.\n        type = me.type = me.props.type = \"Link\"\n        me.Link = me.props.Link = true\n        me.linkpath = me.props.linkpath = hardLinks[k]\n        // console.error(\"Hardlink detected, switching mode\", me._path, me.linkpath)\n        // Setting __proto__ would arguably be the \"correct\"\n        // approach here, but that just seems too wrong.\n        me._stat = me._read = LinkReader.prototype._read\n      }\n    }\n\n    if (me.type && me.type !== type) {\n      me.error(\"Unexpected type: \" + type)\n    }\n\n    // if the filter doesn't pass, then just skip over this one.\n    // still have to emit end so that dir-walking can move on.\n    if (me.filter) {\n      var who = me._proxy || me\n      // special handling for ProxyReaders\n      if (!me.filter.call(who, who, props)) {\n        if (!me._disowned) {\n          me.abort()\n          me.emit(\"end\")\n          me.emit(\"close\")\n        }\n        return\n      }\n    }\n\n    // last chance to abort or disown before the flow starts!\n    var events = [\"_stat\", \"stat\", \"ready\"]\n    var e = 0\n    ;(function go () {\n      if (me._aborted) {\n        me.emit(\"end\")\n        me.emit(\"close\")\n        return\n      }\n\n      if (me._paused && me.type !== \"Directory\") {\n        me.once(\"resume\", go)\n        return\n      }\n\n      var ev = events[e ++]\n      if (!ev) {\n        return me._read()\n      }\n      me.emit(ev, props)\n      go()\n    })()\n  }\n}\n\nReader.prototype.pipe = function (dest, opts) {\n  var me = this\n  if (typeof dest.add === \"function\") {\n    // piping to a multi-compatible, and we've got directory entries.\n    me.on(\"entry\", function (entry) {\n      var ret = dest.add(entry)\n      if (false === ret) {\n        me.pause()\n      }\n    })\n  }\n\n  // console.error(\"R Pipe apply Stream Pipe\")\n  return Stream.prototype.pipe.apply(this, arguments)\n}\n\nReader.prototype.pause = function (who) {\n  this._paused = true\n  who = who || this\n  this.emit(\"pause\", who)\n  if (this._stream) this._stream.pause(who)\n}\n\nReader.prototype.resume = function (who) {\n  this._paused = false\n  who = who || this\n  this.emit(\"resume\", who)\n  if (this._stream) this._stream.resume(who)\n  this._read()\n}\n\nReader.prototype._read = function () {\n  this.error(\"Cannot read unknown type: \"+this.type)\n}\n\n"]}