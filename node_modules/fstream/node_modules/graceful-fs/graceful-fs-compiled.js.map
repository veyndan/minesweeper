{"version":3,"sources":["graceful-fs.js"],"names":[],"mappings":"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","file":"graceful-fs-compiled.js","sourcesContent":["// Monkey-patching the fs module.\n// It's ugly, but there is simply no other way to do this.\nvar fs = module.exports = require('./fs.js')\n\nvar assert = require('assert')\n\n// fix up some busted stuff, mostly on windows and old nodes\nrequire('./polyfills.js')\n\nvar util = require('util')\n\nfunction noop () {}\n\nvar debug = noop\nif (util.debuglog)\n  debug = util.debuglog('gfs')\nelse if (/\\bgfs\\b/i.test(process.env.NODE_DEBUG || ''))\n  debug = function() {\n    var m = util.format.apply(util, arguments)\n    m = 'GFS: ' + m.split(/\\n/).join('\\nGFS: ')\n    console.error(m)\n  }\n\nif (/\\bgfs\\b/i.test(process.env.NODE_DEBUG || '')) {\n  process.on('exit', function() {\n    debug('fds', fds)\n    debug(queue)\n    assert.equal(queue.length, 0)\n  })\n}\n\n\nvar originalOpen = fs.open\nfs.open = open\n\nfunction open(path, flags, mode, cb) {\n  if (typeof mode === \"function\") cb = mode, mode = null\n  if (typeof cb !== \"function\") cb = noop\n  new OpenReq(path, flags, mode, cb)\n}\n\nfunction OpenReq(path, flags, mode, cb) {\n  this.path = path\n  this.flags = flags\n  this.mode = mode\n  this.cb = cb\n  Req.call(this)\n}\n\nutil.inherits(OpenReq, Req)\n\nOpenReq.prototype.process = function() {\n  originalOpen.call(fs, this.path, this.flags, this.mode, this.done)\n}\n\nvar fds = {}\nOpenReq.prototype.done = function(er, fd) {\n  debug('open done', er, fd)\n  if (fd)\n    fds['fd' + fd] = this.path\n  Req.prototype.done.call(this, er, fd)\n}\n\n\nvar originalReaddir = fs.readdir\nfs.readdir = readdir\n\nfunction readdir(path, cb) {\n  if (typeof cb !== \"function\") cb = noop\n  new ReaddirReq(path, cb)\n}\n\nfunction ReaddirReq(path, cb) {\n  this.path = path\n  this.cb = cb\n  Req.call(this)\n}\n\nutil.inherits(ReaddirReq, Req)\n\nReaddirReq.prototype.process = function() {\n  originalReaddir.call(fs, this.path, this.done)\n}\n\nReaddirReq.prototype.done = function(er, files) {\n  if (files && files.sort)\n    files = files.sort()\n  Req.prototype.done.call(this, er, files)\n  onclose()\n}\n\n\nvar originalClose = fs.close\nfs.close = close\n\nfunction close (fd, cb) {\n  debug('close', fd)\n  if (typeof cb !== \"function\") cb = noop\n  delete fds['fd' + fd]\n  originalClose.call(fs, fd, function(er) {\n    onclose()\n    cb(er)\n  })\n}\n\n\nvar originalCloseSync = fs.closeSync\nfs.closeSync = closeSync\n\nfunction closeSync (fd) {\n  try {\n    return originalCloseSync(fd)\n  } finally {\n    onclose()\n  }\n}\n\n\n// Req class\nfunction Req () {\n  // start processing\n  this.done = this.done.bind(this)\n  this.failures = 0\n  this.process()\n}\n\nReq.prototype.done = function (er, result) {\n  var tryAgain = false\n  if (er) {\n    var code = er.code\n    var tryAgain = code === \"EMFILE\" || code === \"ENFILE\"\n    if (process.platform === \"win32\")\n      tryAgain = tryAgain || code === \"OK\"\n  }\n\n  if (tryAgain) {\n    this.failures ++\n    enqueue(this)\n  } else {\n    var cb = this.cb\n    cb(er, result)\n  }\n}\n\nvar queue = []\n\nfunction enqueue(req) {\n  queue.push(req)\n  debug('enqueue %d %s', queue.length, req.constructor.name, req)\n}\n\nfunction onclose() {\n  var req = queue.shift()\n  if (req) {\n    debug('process', req.constructor.name, req)\n    req.process()\n  }\n}\n"]}